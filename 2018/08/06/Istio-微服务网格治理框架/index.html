<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="杜政颉的博客">
    <meta name="keyword"  content="爱车保">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        Istio-微服务网格治理框架 - 杜政颉的博客
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 天行健，君子以自强不息；地势坤，君子以厚德载物 </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/images/avartar.jpg" />
        </div>
        <div class="name">
            <i>杜政颉</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-引言"><span class="toc-text">0 引言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-服务网格"><span class="toc-text">1 服务网格</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-定义"><span class="toc-text">1.1 定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-演化史"><span class="toc-text">1.2 演化史</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-时间线"><span class="toc-text">1.3 时间线</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Istio"><span class="toc-text">2 Istio</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-概览"><span class="toc-text">2.1 概览</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-核心功能"><span class="toc-text">2.2 核心功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-流量管理"><span class="toc-text">2.2.1 流量管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-安全"><span class="toc-text">2.2.2 安全</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-可观察性"><span class="toc-text">2.2.3 可观察性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-4-平台支持"><span class="toc-text">2.2.4 平台支持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-5-集成和定制"><span class="toc-text">2.2.5 集成和定制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-6-架构"><span class="toc-text">2.2.6 架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-6-1-Envoy"><span class="toc-text">2.2.6.1 Envoy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-6-2-Mixer"><span class="toc-text">2.2.6.2 Mixer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-6-3-Pilot"><span class="toc-text">2.2.6.3 Pilot</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-6-4-Citadel"><span class="toc-text">2.2.6.4 Citadel</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-设计目标"><span class="toc-text">2.3 设计目标</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-参考"><span class="toc-text">3 参考</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i> 天行健，君子以自强不息；地势坤，君子以厚德载物 </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Istio-微服务网格治理框架
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2018-08-06 11:08:30</span></span>
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h1 id="0-引言"><a href="#0-引言" class="headerlink" title="0 引言"></a>0 引言</h1><p>随着微服务架构的大量普及，随着服务的增加，微服务架构变得越来越难管理。在我们面向对象、面向过程的架构中，解决问题、追踪问题基本上都可以通过IDE来进行。而在微服务架构中，服务相互独立，而又相互交织，问题跟踪无法像以前那样来处理。追踪问题其实就是路由的追踪。因此，服务网格应运而生（service mesh）,自2016年9月Linkerd第一次公开使用之后，伴随着Linkerd、Envoy、Istio、NGINX Application Platform、Conduit等新框架如雨后春笋般不断涌现，在微服务之后，服务网格和它的边车（Sidecar）模式引领了IT技术界2017一整年的走向。这其中最具代表性的就要属于Istio，这个由谷歌、IBM、Lyft(Uber的竞争对手)倡导的服务网格框架获得了众多的青睐。</p>
<h1 id="1-服务网格"><a href="#1-服务网格" class="headerlink" title="1 服务网格"></a>1 服务网格</h1><h2 id="1-1-定义"><a href="#1-1-定义" class="headerlink" title="1.1 定义"></a>1.1 定义</h2><p>首先，我们来看一下服务网格的提出者William Morgan是如何描述它的。A service mesh is a dedicated infrastructure layer for handling service-to-service communication. Consists of a control plane and data plane (service proxies act as “mesh”). - William Morgan, What’s a Service Mesh? And Why Do I Need One?<sup>[2]</sup></p>
<p>上面这段话非常清晰的指明了服务网格的职责，即处理服务间通讯，这正是服务治理的核心所在。而a dedicated infrastructure layer这几个单词将服务网格和之前所有的微服务框架（framework）划清了界限，也即服务网格独立于具体的服务而存在，这从根本上解决了前文提到的老的微服务框架在多语言支持和代码侵入方面存在的问题。并且，由于服务网格的独立性，业务团队不再需要操心服务治理相关的复杂度，全权交给服务网格处理即可。<br>那你可能会问，这不跟之前提到的代理模式差不多吗？区别在于服务网格独创的边车模式。针对每一个服务实例，服务网格都会在同一主机上一对一并行部署一个边车进程，接管该服务实例所有对外的网络通讯（参见下图）。这样就去除了代理模式下中心化架构的瓶颈。同时，借助于良好的框架封装，运维成本也可以得到有效的控制。</p>
<p><img src="/images/service-mesh.png" alt="image"></p>
<h2 id="1-2-演化史"><a href="#1-2-演化史" class="headerlink" title="1.2 演化史"></a>1.2 演化史</h2><p>追本溯源，服务网格从无到有可分为三个演化阶段（参见下图）。第一个阶段，每个服务各显神通，自行处理对外通讯。第二个阶段，所有服务使用统一的类库进行通讯。第三个阶段，服务不再关心通讯细节，统统交给边车进程，就像在TCP/IP协议中，应用层只需把要传输的内容告诉TCP层，由TCP层负责将所有内容原封不动的送达目的端，整个过程中应用层并不需要关心实际传输过程中的任何细节。</p>
<p><img src="/images/m1.png" alt="image"></p>
<p><img src="/images/m2.png" alt="image"></p>
<p><img src="/images/m3.png" alt="image"></p>
<h2 id="1-3-时间线"><a href="#1-3-时间线" class="headerlink" title="1.3 时间线"></a>1.3 时间线</h2><p>最后，再来回看一下服务网格年轻的历史。虽然服务网格的正式提出是在2016年9月，但其实早在2013年，Airbnb就提出了类似的想法——SmartStack<sup>[4]</sup>，只不过SmartStack局限于服务发现，并没有引起太多关注，类似的还有Netflix的Prana和唯品会的OSP Local Proxy。2016年服务网格提出之后，以Linkerd和Envoy为代表的框架开始崭露头角，并于2017年先后加入CNCF基金（Cloud Native Computing Foundation），最终促使了一代新贵Istio的诞生。2018年，Istio将发布1.0版本，这也许意味着微服务开始进入2.0时代。</p>
<p><img src="/images/m4.png" alt="image"></p>
<h1 id="2-Istio"><a href="#2-Istio" class="headerlink" title="2 Istio"></a>2 Istio</h1><h2 id="2-1-概览"><a href="#2-1-概览" class="headerlink" title="2.1 概览"></a>2.1 概览</h2><p>首先，Istio是服务网格的具体实现，它包括服务发现、负载均衡、故障恢复、指标收集和监控以及通常更加复杂的运维需求，例如 A/B 测试、金丝雀发布、限流、访问控制和端到端认证等。</p>
<p>Istio 提供一种简单的方式来为已部署的服务建立网络，该网络具有负载均衡、服务间认证、监控等功能，而不需要对服务的代码做任何改动。想要让服务支持 Istio，只需要在您的环境中部署一个特殊的 sidecar 代理，使用 Istio 控制平面功能配置和管理代理，拦截微服务之间的所有网络通信：</p>
<ul>
<li>HTTP、gRPC、WebSocket 和 TCP 流量的自动负载均衡。</li>
<li>通过丰富的路由规则、重试、故障转移和故障注入，可以对流量行为进行细粒度控制。</li>
<li>可插入的策略层和配置 API，支持访问控制、速率限制和配额。</li>
<li>对出入集群入口和出口中所有流量的自动度量指标、日志记录和跟踪。</li>
<li>通过强大的基于身份的验证和授权，在集群中实现安全的服务间通信。</li>
</ul>
<h2 id="2-2-核心功能"><a href="#2-2-核心功能" class="headerlink" title="2.2 核心功能"></a>2.2 核心功能</h2><h3 id="2-2-1-流量管理"><a href="#2-2-1-流量管理" class="headerlink" title="2.2.1 流量管理"></a>2.2.1 流量管理</h3><p>通过简单的规则配置和流量路由，您可以控制服务之间的流量和 API 调用。Istio 简化了断路器、超时和重试等服务级别属性的配置，并且可以轻松设置 A/B测试、金丝雀部署和基于百分比的流量分割的分阶段部署等重要任务。</p>
<p>通过更好地了解您的流量和开箱即用的故障恢复功能，您可以在问题出现之前先发现问题，使调用更可靠，并且使您的网络更加强大——无论您面临什么条件。</p>
<h3 id="2-2-2-安全"><a href="#2-2-2-安全" class="headerlink" title="2.2.2 安全"></a>2.2.2 安全</h3><p>Istio 的安全功能使开发人员可以专注于应用程序级别的安全性。Istio 提供底层安全通信信道，并大规模管理服务通信的认证、授权和加密。使用Istio，服务通信在默认情况下是安全的，它允许您跨多种协议和运行时一致地实施策略——所有这些都很少或根本不需要应用程序更改。</p>
<p>虽然 Istio 与平台无关，但将其与 Kubernetes（或基础架构）网络策略结合使用，其优势会更大，包括在网络和应用层保护 pod 间或服务间通信的能力。</p>
<h3 id="2-2-3-可观察性"><a href="#2-2-3-可观察性" class="headerlink" title="2.2.3 可观察性"></a>2.2.3 可观察性</h3><p>Istio 强大的跟踪、监控和日志记录可让您深入了解服务网格部署。通过 Istio 的监控功能，可以真正了解服务性能如何影响上游和下游的功能，而其自定义仪表板可以提供对所有服务性能的可视性，并让您了解该性能如何影响您的其他进程。</p>
<p>Istio 的 Mixer 组件负责策略控制和遥测收集。它提供后端抽象和中介，将 Istio 的其余部分与各个基础架构后端的实现细节隔离开来，并为运维提供对网格和基础架构后端之间所有交互的细粒度控制。</p>
<p>所有这些功能可以让您可以更有效地设置、监控和实施服务上的 SLO。当然，最重要的是，您可以快速有效地检测和修复问题。</p>
<h3 id="2-2-4-平台支持"><a href="#2-2-4-平台支持" class="headerlink" title="2.2.4 平台支持"></a>2.2.4 平台支持</h3><p>Istio 是独立于平台的，旨在运行在各种环境中，包括跨云、内部部署、Kubernetes、Mesos 等。您可以在 Kubernetes 上部署 Istio 或具有 Consul 的 Nomad 上部署。Istio 目前支持：</p>
<ul>
<li>在 Kubernetes 上部署的服务</li>
<li>使用 Consul 注册的服务</li>
<li>在虚拟机上部署的服务</li>
</ul>
<h3 id="2-2-5-集成和定制"><a href="#2-2-5-集成和定制" class="headerlink" title="2.2.5 集成和定制"></a>2.2.5 集成和定制</h3><p>策略执行组件可以扩展和定制，以便与现有的 ACL、日志、监控、配额、审计等方案集成。</p>
<h3 id="2-2-6-架构"><a href="#2-2-6-架构" class="headerlink" title="2.2.6 架构"></a>2.2.6 架构</h3><p>Istio 服务网格逻辑上分为<strong>数据平面</strong>和<strong>控制平面</strong>。</p>
<ul>
<li><strong>数据平面</strong>由一组以 sidecar 方式部署的智能代理（Envoy）组成。这些代理可以调节和控制微服务及 Mixer 之间所有的网络通信。</li>
<li><strong>控制平面</strong>负责管理和配置代理来路由流量。此外控制平面配置 Mixer 以实施策略和收集遥测数据。</li>
</ul>
<p>下图显示了构成每个面板的不同组件：</p>
<p><img src="/images/m5.svg" alt="image"></p>
<h4 id="2-2-6-1-Envoy"><a href="#2-2-6-1-Envoy" class="headerlink" title="2.2.6.1 Envoy"></a>2.2.6.1 Envoy</h4><p>Istio 使用 Envoy 代理的扩展版本，Envoy 是以 C++ 开发的高性能代理，用于调解服务网格中所有服务的所有入站和出站流量。Envoy 的许多内置功能被 istio 发扬光大，例如：</p>
<ul>
<li>动态服务发现</li>
<li>负载均衡</li>
<li>TLS 终止</li>
<li>HTTP/2 &amp; gRPC 代理</li>
<li>熔断器</li>
<li>健康检查、基于百分比流量拆分的灰度发布</li>
<li>故障注入</li>
<li>丰富的度量指标</li>
</ul>
<p>Envoy 被部署为 sidecar，和对应服务在同一个 Kubernetes pod 中。这允许 Istio 将大量关于流量行为的信号作为属性提取出来，而这些属性又可以在 Mixer 中用于执行策略决策，并发送给监控系统，以提供整个网格行为的信息。</p>
<p>Sidecar 代理模型还可以将 Istio 的功能添加到现有部署中，而无需重新构建或重写代码。可以阅读更多来了解为什么我们在设计目标中选择这种方式。</p>
<h4 id="2-2-6-2-Mixer"><a href="#2-2-6-2-Mixer" class="headerlink" title="2.2.6.2 Mixer"></a>2.2.6.2 Mixer</h4><p>Mixer 是一个独立于平台的组件，负责在服务网格上执行访问控制和使用策略，并从 Envoy 代理和其他服务收集遥测数据。代理提取请求级属性，发送到 Mixer 进行评估。有关属性提取和策略评估的更多信息，请参见 Mixer 配置。</p>
<p>Mixer 中包括一个灵活的插件模型，使其能够接入到各种主机环境和基础设施后端，从这些细节中抽象出 Envoy 代理和 Istio 管理的服务。</p>
<h4 id="2-2-6-3-Pilot"><a href="#2-2-6-3-Pilot" class="headerlink" title="2.2.6.3 Pilot"></a>2.2.6.3 Pilot</h4><p>Pilot 为 Envoy sidecar 提供服务发现功能，为智能路由（例如 A/B 测试、金丝雀部署等）和弹性（超时、重试、熔断器等）提供流量管理功能。它将控制流量行为的高级路由规则转换为特定于 Envoy 的配置，并在运行时将它们传播到 sidecar。</p>
<p>Pilot 将平台特定的服务发现机制抽象化并将其合成为符合 Envoy 数据平面 API 的任何 sidecar 都可以使用的标准格式。这种松散耦合使得 Istio 能够在多种环境下运行（例如，Kubernetes、Consul、Nomad），同时保持用于流量管理的相同操作界面。</p>
<h4 id="2-2-6-4-Citadel"><a href="#2-2-6-4-Citadel" class="headerlink" title="2.2.6.4 Citadel"></a>2.2.6.4 Citadel</h4><p>Citadel 通过内置身份和凭证管理可以提供强大的服务间和最终用户身份验证。可用于升级服务网格中未加密的流量，并为运维人员提供基于服务标识而不是网络控制的强制执行策略的能力。从 0.5 版本开始，Istio 支持基于角色的访问控制，以控制谁可以访问您的服务。</p>
<h3 id="2-3-设计目标"><a href="#2-3-设计目标" class="headerlink" title="2.3 设计目标"></a>2.3 设计目标</h3><p>Istio 的架构设计中有几个关键目标，这些目标对于使系统能够应对大规模流量和高性能地服务处理至关重要。</p>
<ul>
<li><strong>最大化透明度</strong>：若想 Istio 被采纳，应该让运维和开发人员只需付出很少的代价就可以从中受益。为此，Istio 将自身自动注入到服务间所有的网络路径中。Istio 使用 sidecar 代理来捕获流量，并且在尽可能的地方自动编程网络层，以路由流量通过这些代理，而无需对已部署的应用程序代码进行任何改动。在 Kubernetes中，代理被注入到 pod 中，通过编写 iptables 规则来捕获流量。注入 sidecar 代理到 pod 中并且修改路由规则后，Istio 就能够调解所有流量。这个原则也适用于性能。当将 Istio 应用于部署时，运维人员可以发现，为提供这些功能而增加的资源开销是很小的。所有组件和 API 在设计时都必须考虑性能和规模。</li>
<li><strong>增量</strong>：随着运维人员和开发人员越来越依赖 Istio 提供的功能，系统必然和他们的需求一起成长。虽然我们期望继续自己添加新功能，但是我们预计最大的需求是扩展策略系统，集成其他策略和控制来源，并将网格行为信号传播到其他系统进行分析。策略运行时支持标准扩展机制以便插入到其他服务中。此外，它允许扩展词汇表，以允许基于网格生成的新信号来执行策略。 </li>
<li><strong>可移植性</strong>：使用 Istio 的生态系统将在很多维度上有差异。Istio 必须能够以最少的代价运行在任何云或预置环境中。将基于 Istio 的服务移植到新环境应该是轻而易举的，而使用 Istio 将一个服务同时部署到多个环境中也是可行的（例如，在多个云上进行冗余部署）。</li>
<li><strong>策略一致性</strong>：在服务间的 API 调用中，策略的应用使得可以对网格间行为进行全面的控制，但对于无需在 API 级别表达的资源来说，对资源应用策略也同样重要。例如，将配额应用到 ML 训练任务消耗的 CPU 数量上，比将配额应用到启动这个工作的调用上更为有用。因此，策略系统作为独特的服务来维护，具有自己的 API，而不是将其放到代理/sidecar 中，这容许服务根据需要直接与其集成。</li>
</ul>
<h1 id="3-参考"><a href="#3-参考" class="headerlink" title="3 参考"></a>3 参考</h1><ol>
<li><a href="https://blog.csdn.net/M2l0ZgSsVc7r69eFdTj/article/details/79800045" target="_blank" rel="noopener">https://blog.csdn.net/M2l0ZgSsVc7r69eFdTj/article/details/79800045</a></li>
<li><a href="https://blog.csdn.net/M2l0ZgSsVc7r69eFdTj/article/details/79800045" target="_blank" rel="noopener">https://blog.csdn.net/M2l0ZgSsVc7r69eFdTj/article/details/79800045</a></li>
<li><a href="https://preliminary.istio.io/zh/docs" target="_blank" rel="noopener">https://preliminary.istio.io/zh/docs</a></li>
<li><a href="https://medium.com/airbnb-engineering/smartstack-service-discovery-in-the-cloud-4b8a080de619" target="_blank" rel="noopener">https://medium.com/airbnb-engineering/smartstack-service-discovery-in-the-cloud-4b8a080de619</a></li>
</ol>

        
        <div id="comment-container">
        </div>
    </div>
</div>
    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        
        <li>
            <a target="_blank"  href="https://github.com/git-duzhengjie">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script src="/js/gitment.js"></script>
<script>
    var gitment = new Gitment({
        id: 'Istio-微服务网格治理框架',
        owner: 'git-duzhengjie',
        repo: 'git-duzhengjie.github.io',
        oauth: {
            client_id: '0088ec0e0601ed2c1cd6',
            client_secret: '7e85fbfaf92187d769ca1cde7270dfe585bfc867',
        },
    })
    gitment.render('comment-container')
</script>

</html>
